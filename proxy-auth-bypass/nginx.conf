server {
    listen 80;
    server_name _;

    # Proxy auth endpoint with raw query string validation
    # The gateway requires "token=" to appear in the query string
    # before forwarding to the application backend
    location /auth {
        if ($query_string !~ "token=") {
            add_header Content-Type "application/json" always;
            return 401 '{"error": "gateway_rejected", "message": "Missing required authentication parameter"}';
        }
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # All other routes pass through to the application
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
